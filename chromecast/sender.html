<html data-cast-api-enabled="true" xmlns="http://www.w3.org/1999/html">
	<head>
		<title>Hello World Chrome Sender</title>
	</head>
	<body>
		<div class="receiver-div">
			<h3>Choose A Receiver</h3>
			<ul class="receiver-list">
				<li>Looking for receivers...</li>
			</ul>
		</div>
		<button class="load">Load</button>
		<button class="kill" disabled>Kill the Connection</button>
		<button class="play">Play</button>
		<button class="stop">Stop</button>
	</body>

	<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
	<script src="http://underscorejs.org/underscore-min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        socket.on('connect', function(){
            console.log('connected');
        });
        socket.on('ServerEvent', function(data){
            console.log(data);
        });
        socket.on('disconnect', function(){
            console.log('disconnect');
        });

        function sendEvent(data) {
            socket.emit('ClientEvent', {some: data});
        }
    </script>

    <script>
		var cast_api,
			cv_activity,
			receiverList,
			$killSwitch = $('.kill'),
			$loadSwitch= $('.load'),
			$playBtn= $('.play');
			$stopBtn= $('.stop');

		initializeApi = function() {
            if (!chrome.cast || !chrome.cast.isAvailable) {
                setTimeout(initializeCastApi, 1000);
            }

            function initializeCastApi() {
                var sessionRequest = new chrome.cast.SessionRequest('B7A2237F');
                var apiConfig = new chrome.cast.ApiConfig(sessionRequest, sessionListener, receiverListener);
                chrome.cast.initialize(apiConfig, function() {
                    console.log('success');
                }, function() {
                    console.log('on error');
                });
            }

            function sessionListener(ev) {
                console.log('on session');

                var session = ev;


                if (session.media.length != 0) {
                    onMediaDiscovered('onRequestSessionSuccess', session.media[0]);
                }
            }

            function receiverListener(e) {

                console.log('receiver listener fired', e)

                if( e === chrome.cast.ReceiverAvailability.AVAILABLE) {
                    console.log('receiver listener, listener available')
                }
            }

		};

		onReceiverList = function(list) {
			if (list.length > 0) {
				receiverList = list;

				$('.receiver-list').empty();
				receiverList.forEach(function(receiver) {
					$listItem = $('<li><a href="#" data-id="' + receiver.id + '">' + receiver.name + '</a></li>');
					$listItem.on('click', receiverClicked);
					$('.receiver-list').append($listItem);
				});
			}
		};

		receiverClicked = function(e) {
			e.preventDefault();

			var $target = $(e.target),
				receiver = _.find(receiverList, function(receiver) {
					return receiver.id === $target.data('id');
				});

			doLaunch(receiver);
		};

		doLaunch = function(receiver) {
			if (!cv_activity) {
				var request = new cast.LaunchRequest('B7A2237F', receiver);

				$killSwitch.prop('disabled', false);

				cast_api.launch(request, onLaunch);
			}
		};

		onLaunch = function(activity) {
			if (activity.status === 'running') {
				cv_activity = activity;
				
				cast_api.sendMessage(cv_activity.activityId, 'HelloWorld', {type: 'HelloWorld'});
			}
		};

		$loadSwitch.on('click', function() {
            chrome.cast.requestSession(onRequestSessionSuccess, onLaunchError);

            function onRequestSessionSuccess(e) {
                console.log('on request sesssion sucess')

                session = e;

            }

            function onLaunchError(e) {
                console.log('on launch error', e)
            }


        });
		$killSwitch.on('click', function() {
			cast_api.stopActivity(cv_activity.activityId, function(){
				cv_activity = null;
			
				$killSwitch.prop('disabled', true);
			});
		});

        initializeApi();

    </script>
    <script src="audiodata.js"></script>
</html>